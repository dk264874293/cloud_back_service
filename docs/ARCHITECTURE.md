# äº‘ä¸Šç½‘ç‚¹å¹³å°åç«¯ - æ¶æ„è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº‘ä¸Šç½‘ç‚¹å¹³å°åç«¯çš„æ¶æ„è®¾è®¡ã€æŠ€æœ¯é€‰å‹å’Œå®ç°ç»†èŠ‚ã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
- [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
- [ä¸šåŠ¡æµç¨‹](#ä¸šåŠ¡æµç¨‹)
- [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)

## ğŸŒ ç³»ç»Ÿæ¦‚è¿°

### ä¸šåŠ¡ç›®æ ‡

äº‘ä¸Šç½‘ç‚¹å¹³å°æ˜¯ä¸€ä¸ªè¿æ¥ç”¨æˆ·ã€æœåŠ¡å•†ã€é“¶è¡Œçš„é‡‘èéœ€æ±‚åŒ¹é…å¹³å°ï¼Œå®ç°ä»¥ä¸‹ç›®æ ‡ï¼š

1. **éœ€æ±‚åŒ¹é…** - é«˜æ•ˆåŒ¹é…ç”¨æˆ·é‡‘èéœ€æ±‚ä¸é“¶è¡Œäº§å“
2. **æœåŠ¡æ ‡å‡†åŒ–** - æ ‡å‡†åŒ–æœåŠ¡æµç¨‹ï¼Œæå‡æœåŠ¡è´¨é‡
3. **åˆ©ç›Šåˆ†é…** - å…¬å¹³é€æ˜çš„å¤šè§’è‰²åˆ©ç›Šåˆ†é…æœºåˆ¶
4. **æ•°æ®å®‰å…¨** - ä¸¥æ ¼çš„æ•°æ®å®‰å…¨ä¸éšç§ä¿æŠ¤

### ç³»ç»Ÿè§’è‰²

| è§’è‰²             | æè¿°                       | æ ¸å¿ƒèŒè´£                                           |
| ---------------- | -------------------------- | -------------------------------------------------- |
| **æ™®é€šç”¨æˆ·**     | æœ‰é‡‘èéœ€æ±‚çš„ä¸ªäººæˆ–ä¼ä¸š     | å‘å¸ƒéœ€æ±‚ã€æŸ¥çœ‹è®¢å•ã€æç°ã€é‚€è¯·å¥½å‹                 |
| **ç®¡æˆ·äºº**       | è´Ÿè´£ç”¨æˆ·æ²Ÿé€šä¸å…³ç³»ç»´æŠ¤     | æ¥ç®¡è®¢å•ã€ä¸Šä¼ éœ€æ±‚æŠ¥å‘Šã€é™ªåŒæ²Ÿé€š                   |
| **è®¿è°ˆäºº**       | è´Ÿè´£æ¢³ç†ç”¨æˆ·éœ€æ±‚å¹¶ç”ŸæˆæŠ¥å‘Š | æ¥æ”¶è®¿è°ˆä»»åŠ¡ã€ç”Ÿæˆå®¢æˆ·éœ€æ±‚æŠ¥å‘Š                     |
| **ä¸šåŠ¡å—ç†äºº**   | è´Ÿè´£çº¿ä¸‹å¯¹æ¥é“¶è¡ŒåŠç†æ‰‹ç»­   | æ¥æ”¶å§”æ‰˜ä»»åŠ¡ã€å¯¹æ¥é“¶è¡Œ                             |
| **é“¶è¡Œå®¢æˆ·ç»ç†** | é“¶è¡Œç«¯äººå‘˜ï¼Œè´­ä¹°éœ€æ±‚æŠ¥å‘Š   | æŸ¥çœ‹è®¢å•ã€æ”¯ä»˜è´­ä¹°ã€çº¿ä¸‹å¯¹æ¥ã€åé¦ˆå®¡æ‰¹ç»“æœ         |
| **å¼€å‘äºº**       | æŒ–æ˜å®¢æˆ·èµ„æºï¼Œé‚€è¯·ç”¨æˆ·å…¥é©» | æŸ¥çœ‹ä½£é‡‘ã€é‚€è¯·æ¨å¹¿                                 |
| **è¿è¥ç®¡ç†å‘˜**   | å¹³å°è¿è¥ç®¡ç†               | å®¢æˆ·ç®¡ç†ã€æœåŠ¡å•†ç®¡ç†ã€è®¢å•ç®¡ç†ã€è´¢åŠ¡ç®¡ç†ã€åˆ†ä½£é…ç½® |

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·ç«¯H5    â”‚  æœåŠ¡å•†ç«¯H5  â”‚  é“¶è¡Œç«¯H5    â”‚  è¿è¥åå°Web   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚              â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTPS
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Nginx åå‘ä»£ç†                           â”‚
â”‚  - SSL/TLSç»ˆæ­¢                                               â”‚
â”‚  - è´Ÿè½½å‡è¡¡                                                   â”‚
â”‚  - é™æ€èµ„æºæœåŠ¡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NestJS åº”ç”¨ç¨‹åº                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        è¡¨ç°å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Controllerâ”‚  â”‚ Guards   â”‚  â”‚ Interceptor â”‚          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        ä¸šåŠ¡å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚AuthServiceâ”‚  â”‚OrderServiceâ”‚          â”‚          â”‚   â”‚
â”‚  â”‚UserServiceâ”‚  â”‚PaymentServiceâ”‚       â”‚          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ•°æ®è®¿é—®å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Entity  â”‚  â”‚  Repository   â”‚          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL   â”‚ â”‚  Redis   â”‚ â”‚  é˜¿é‡Œäº‘  â”‚ â”‚ å¾®ä¿¡æ”¯ä»˜  â”‚
â”‚ Database â”‚ â”‚  Cache   â”‚ â”‚   OSS    â”‚ â”‚   API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚æ¶æ„

#### 1. è¡¨ç°å±‚ (Presentation Layer)

- **èŒè´£**: å¤„ç†HTTPè¯·æ±‚ã€å‚æ•°éªŒè¯ã€å“åº”æ ¼å¼åŒ–
- **ç»„ä»¶**:
  - Controller: æ§åˆ¶å™¨ï¼Œå®šä¹‰è·¯ç”±
  - Guards: å®ˆå«ï¼Œè®¤è¯æˆæƒ
  - Interceptors: æ‹¦æˆªå™¨ï¼Œè¯·æ±‚/å“åº”å¤„ç†
  - Filters: è¿‡æ»¤å™¨ï¼Œå¼‚å¸¸å¤„ç†

#### 2. ä¸šåŠ¡å±‚ (Business Layer)

- **èŒè´£**: å®ç°ä¸šåŠ¡é€»è¾‘ã€çŠ¶æ€ç®¡ç†ã€è§„åˆ™è®¡ç®—
- **ç»„ä»¶**:
  - Service: æœåŠ¡ç±»ï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
  - DTO: æ•°æ®ä¼ è¾“å¯¹è±¡ï¼Œæ¥å£å®šä¹‰
  - Enums: æšä¸¾ï¼ŒçŠ¶æ€ä¸ç±»å‹å®šä¹‰

#### 3. æ•°æ®è®¿é—®å±‚ (Data Access Layer)

- **èŒè´£**: æ•°æ®åº“æ“ä½œã€æ•°æ®æŒä¹…åŒ–
- **ç»„ä»¶**:
  - Entity: å®ä½“ç±»ï¼Œæ•°æ®æ¨¡å‹
  - Repository: ä»“å‚¨ç±»ï¼Œæ•°æ®è®¿é—®

### æ¨¡å—åˆ’åˆ†

```
AppModule (æ ¹æ¨¡å—)
â”œâ”€â”€ ConfigModule (é…ç½®æ¨¡å—)
â”œâ”€â”€ AuthModule (è®¤è¯æ¨¡å—)
â”œâ”€â”€ UserModule (ç”¨æˆ·æ¨¡å—)
â”œâ”€â”€ OrderModule (è®¢å•æ¨¡å—)
â”œâ”€â”€ PaymentModule (æ”¯ä»˜æ¨¡å—)
â”œâ”€â”€ CommissionModule (åˆ†ä½£æ¨¡å—)
â”œâ”€â”€ FileModule (æ–‡ä»¶æ¨¡å—)
â”œâ”€â”€ ServiceProviderModule (æœåŠ¡å•†æ¨¡å—)
â”œâ”€â”€ BankModule (é“¶è¡Œæ¨¡å—)
â”œâ”€â”€ WithdrawalModule (æç°æ¨¡å—)
â”œâ”€â”€ InvitationModule (é‚€è¯·æ¨¡å—)
â”œâ”€â”€ FeedbackModule (åé¦ˆæ¨¡å—)
â””â”€â”€ AdminModule (è¿è¥ç®¡ç†æ¨¡å—)
```

## ğŸ”§ æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆé€‰æ‹©

#### åç«¯æ¡†æ¶: NestJS

**é€‰æ‹©ç†ç”±**:

- ä¼ä¸šçº§Node.jsæ¡†æ¶ï¼Œç»“æ„æ¸…æ™°
- ä¾èµ–æ³¨å…¥è®¾è®¡ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- æ¨¡å—åŒ–æ¶æ„ï¼Œé€‚åˆå¤§å‹é¡¹ç›®
- å®Œå–„çš„TypeScriptæ”¯æŒ
- æ´»è·ƒçš„ç¤¾åŒºå’Œä¸°å¯Œçš„ç”Ÿæ€

#### ORM: TypeORM

**é€‰æ‹©ç†ç”±**:

- æ”¯æŒå¤šç§æ•°æ®åº“ï¼Œè¿ç§»æˆæœ¬ä½
- Active Recordå’ŒData MapperåŒæ¨¡å¼
- å®Œå–„çš„TypeScriptæ”¯æŒ
- æ”¯æŒè£…é¥°å™¨è¯­æ³•ï¼Œä»£ç ç®€æ´

#### æ•°æ®åº“: MySQL 8.0

**é€‰æ‹©ç†ç”±**:

- æˆç†Ÿç¨³å®šï¼Œæ€§èƒ½ä¼˜ç§€
- äº‹åŠ¡æ”¯æŒå®Œå–„
- JSONå­—æ®µæ”¯æŒï¼Œçµæ´»çš„æ•°æ®å­˜å‚¨
- ä¸»ä»å¤åˆ¶ã€é›†ç¾¤æ–¹æ¡ˆæˆç†Ÿ

#### è®¤è¯: JWT + Passport

**é€‰æ‹©ç†ç”±**:

- JWTæ— çŠ¶æ€ï¼Œé€‚åˆåˆ†å¸ƒå¼
- Passportç­–ç•¥çµæ´»ï¼Œæ˜“äºæ‰©å±•
- åŒä»¤ç‰Œæœºåˆ¶ï¼Œå®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒå…¼é¡¾

#### APIæ–‡æ¡£: Swagger

**é€‰æ‹©ç†ç”±**:

- è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬
- äº¤äº’å¼æ–‡æ¡£ï¼Œä¾¿äºæµ‹è¯•
- å¹¿æ³›ä½¿ç”¨ï¼Œå›¢é˜Ÿå­¦ä¹ æˆæœ¬ä½

### å…³é”®æŠ€æœ¯å†³ç­–

#### 1. ä¸ºä»€ä¹ˆä½¿ç”¨TypeORMè€Œä¸æ˜¯Prismaï¼Ÿ

**TypeORMä¼˜åŠ¿**:

- æ”¯æŒè£…é¥°å™¨è¯­æ³•ï¼Œä»£ç æ›´ç®€æ´
- æ›´çµæ´»çš„æŸ¥è¯¢æ„å»ºå™¨
- æ›´æˆç†Ÿçš„è¿ç§»ç³»ç»Ÿ
- æ›´å¥½çš„TypeScripté›†æˆ

#### 2. ä¸ºä»€ä¹ˆä½¿ç”¨MySQLè€Œä¸æ˜¯PostgreSQLï¼Ÿ

**MySQLä¼˜åŠ¿**:

- å›¢é˜Ÿç†Ÿæ‚‰åº¦é«˜
- è¿ç»´æˆæœ¬ä½
- äº‘æœåŠ¡å•†æ”¯æŒå¥½
- æ€§èƒ½æ»¡è¶³éœ€æ±‚

#### 3. ä¸ºä»€ä¹ˆä½¿ç”¨JWTè€Œä¸æ˜¯Sessionï¼Ÿ

**JWTä¼˜åŠ¿**:

- æ— çŠ¶æ€ï¼Œæ˜“äºæ°´å¹³æ‰©å±•
- è·¨åŸŸæ”¯æŒå¥½
- ç§»åŠ¨ç«¯å‹å¥½
- å‡å°‘æœåŠ¡å™¨å­˜å‚¨å‹åŠ›

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### ERå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚       â”‚ ServiceProvider  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id       â”‚â”€â”€â”    â”‚ PK id            â”‚
â”‚    phone    â”‚  â”‚    â”‚    name          â”‚
â”‚    role     â”‚  â”‚    â”‚    type          â”‚
â”‚    ...      â”‚  â”‚    â”‚    ...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚            â”‚
                  â”‚ FK         â”‚ FK
                  â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConnectionOrder  â”‚    â”‚   Bank           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id            â”‚    â”‚ PK id            â”‚
â”‚    order_no      â”‚    â”‚    name          â”‚
â”‚ FK user_id       â”‚    â”‚    code          â”‚
â”‚ FK developer_id  â”‚    â”‚    ...           â”‚
â”‚ FK account_mgr_idâ”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ FK interviewer_idâ”‚            â”‚
â”‚ FK selected_bank â”‚â”€â”€â”         â”‚ FK
â”‚    status        â”‚  â”‚         â”‚
â”‚    ...           â”‚  â”‚         â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  â”‚  Payment         â”‚
                      â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚  â”‚ PK id            â”‚
                      â”‚  â”‚    payment_no     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚    amount        â”‚
â”‚ EntrustmentOrder â”‚   â”‚  â”‚    status        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚    ...           â”‚
â”‚ PK id            â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚    order_no      â”‚   â”‚
â”‚ FK conn_order_id â”‚   â”‚
â”‚ FK user_id       â”‚   â”‚
â”‚ FK handler_id    â”‚   â”‚
â”‚    status        â”‚   â”‚
â”‚    ...           â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                      â”‚
                â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                â”‚           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚CommissionRuleâ”‚   â”‚CommissionRec â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK id         â”‚   â”‚ PK id         â”‚
â”‚    province   â”‚   â”‚ FK order_id   â”‚
â”‚    platform%  â”‚   â”‚    amount      â”‚
â”‚    ...        â”‚   â”‚    rate        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    status      â”‚
                    â”‚    ...         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒå®ä½“

#### ç”¨æˆ·è¡¨ (users)

```typescript
{
  id: number;                    // ä¸»é”®
  phone: string;                 // æ‰‹æœºå·ï¼ˆå”¯ä¸€ï¼‰
  password_hash: string;         // å¯†ç å“ˆå¸Œ
  nickname: string;              // æ˜µç§°
  avatar: string;                // å¤´åƒURL
  role: UserRole;                // è§’è‰²
  provider_permissions: ProviderPermission[];  // æœåŠ¡å•†æƒé™
  is_verified: boolean;           // æ˜¯å¦è®¤è¯
  verification_status: string;    // è®¤è¯çŠ¶æ€
  verification_data: JSON;        // è®¤è¯ææ–™
  bank_id: number;               // å…³è”é“¶è¡ŒID
  service_provider_id: number;   // å…³è”æœåŠ¡å•†ID
  created_at: Date;               // åˆ›å»ºæ—¶é—´
  updated_at: Date;               // æ›´æ–°æ—¶é—´
  deleted_at: Date;              // åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰
}
```

#### å¯¹æ¥è®¢å•è¡¨ (connection_orders)

```typescript
{
  id: number;                              // ä¸»é”®
  order_no: string;                        // è®¢å•å·
  user_id: number;                         // ç”¨æˆ·ID
  developer_id: number;                    // å¼€å‘äººID
  account_manager_id: number;             // ç®¡æˆ·äººID
  interviewer_id: number;                  // è®¿è°ˆäººID
  status: ConnectionOrderStatus;          // è®¢å•çŠ¶æ€
  user_type: 'INDIVIDUAL' | 'ENTERPRISE'; // ç”¨æˆ·ç±»å‹
  need_type: 'LOAN' | 'DEPOSIT' | 'FINANCIAL_MANAGEMENT';  // éœ€æ±‚ç±»å‹
  location: string;                       // ä½ç½®
  amount: decimal;                         // éœ€æ±‚é‡‘é¢
  repayment_ability: string;               // è¿˜æ¬¾èƒ½åŠ›æè¿°
  report_url: string;                      // å®¢æˆ·éœ€æ±‚æŠ¥å‘ŠURL
  price: decimal;                          // è®¢å•ä»·æ ¼
  assigned_banks: number[];                // æ´¾å•é“¶è¡ŒIDåˆ—è¡¨
  purchased_by_banks: number[];            // å·²è´­ä¹°çš„é“¶è¡ŒIDåˆ—è¡¨
  selected_bank_id: number;               // ç”¨æˆ·é€‰æ‹©çš„é“¶è¡ŒID
  is_confirmed: boolean;                   // æ˜¯å¦ç°åœºç¡®è®¤
  confirmed_at: Date;                       // ç¡®è®¤æ—¶é—´
  cancel_reason: string;                    // å–æ¶ˆåŸå› 
  created_at: Date;                        // åˆ›å»ºæ—¶é—´
  updated_at: Date;                        // æ›´æ–°æ—¶é—´
}
```

#### å§”æ‰˜è®¢å•è¡¨ (entrustment_orders)

```typescript
{
  id: number; // ä¸»é”®
  order_no: string; // è®¢å•å·
  connection_order_id: number; // å…³è”å¯¹æ¥è®¢å•ID
  user_id: number; // ç”¨æˆ·ID
  account_manager_id: number; // ç®¡æˆ·äººID
  handler_id: number; // ä¸šåŠ¡å—ç†äººID
  status: EntrustmentOrderStatus; // è®¢å•çŠ¶æ€
  agreement_url: string; // åè®®URL
  approval_note: string; // å®¡æ ¸å¤‡æ³¨
  reject_reason: string; // æ‹’ç»åŸå› 
  completion_note: string; // å®Œæˆå¤‡æ³¨
  created_at: Date; // åˆ›å»ºæ—¶é—´
  updated_at: Date; // æ›´æ–°æ—¶é—´
}
```

#### æ”¯ä»˜è®°å½•è¡¨ (payments)

```typescript
{
  id: number; // ä¸»é”®
  payment_no: string; // æ”¯ä»˜å•å·
  order_type: OrderType; // è®¢å•ç±»å‹
  order_id: number; // è®¢å•ID
  order_no: string; // è®¢å•å·
  payer_id: number; // æ”¯ä»˜äººID
  amount: decimal; // æ”¯ä»˜é‡‘é¢
  payment_type: PaymentType; // æ”¯ä»˜æ–¹å¼
  transaction_id: string; // å¾®ä¿¡äº¤æ˜“å·
  status: PaymentStatus; // æ”¯ä»˜çŠ¶æ€
  paid_at: Date; // æ”¯ä»˜æ—¶é—´
  callback_data: JSON; // å›è°ƒæ•°æ®
  created_at: Date; // åˆ›å»ºæ—¶é—´
}
```

#### åˆ†ä½£è§„åˆ™è¡¨ (commission_rules)

```typescript
{
  id: number; // ä¸»é”®
  province: string; // çœä»½ï¼ˆç©ºè¡¨ç¤ºå…¨å›½é»˜è®¤è§„åˆ™ï¼‰
  platform_rate: decimal; // å¹³å°æŠ½æˆæ¯”ä¾‹
  agent_rate: decimal; // ä»£ç†å•†æ¯”ä¾‹
  franchise_rate: decimal; // åŠ ç›Ÿå•†æ¯”ä¾‹
  channel_service_rate: decimal; // æ¸ é“å•†+æœåŠ¡å•†æ¯”ä¾‹
  developer_rate: decimal; // å¼€å‘äººæ¯”ä¾‹
  account_manager_rate: decimal; // ç®¡æˆ·äººæ¯”ä¾‹
  interviewer_rate: decimal; // è®¿è°ˆäººæ¯”ä¾‹
  handler_rate: decimal; // ä¸šåŠ¡å—ç†äººæ¯”ä¾‹
  is_active: boolean; // æ˜¯å¦ç”Ÿæ•ˆ
  created_at: Date; // åˆ›å»ºæ—¶é—´
  updated_at: Date; // æ›´æ–°æ—¶é—´
}
```

#### åˆ†ä½£è®°å½•è¡¨ (commission_records)

```typescript
{
  id: number; // ä¸»é”®
  order_type: OrderType; // è®¢å•ç±»å‹
  order_id: number; // è®¢å•ID
  order_no: string; // è®¢å•å·
  order_amount: decimal; // è®¢å•æ€»é¢
  commission_type: CommissionType; // åˆ†ä½£ç±»å‹
  recipient_id: number; // æ”¶ä½£äººID
  recipient_role: UserRole; // æ”¶ä½£äººè§’è‰²
  amount: decimal; // åˆ†ä½£é‡‘é¢
  rate: decimal; // åˆ†ä½£æ¯”ä¾‹
  status: CommissionStatus; // çŠ¶æ€
  paid_at: Date; // æ”¯ä»˜æ—¶é—´
  created_at: Date; // åˆ›å»ºæ—¶é—´
}
```

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

### 1. è®¤è¯æ¨¡å— (AuthModule)

#### åŠŸèƒ½

- ç”¨æˆ·æ³¨å†Œ
- ç”¨æˆ·ç™»å½•
- åˆ·æ–°ä»¤ç‰Œ
- ç”¨æˆ·ç™»å‡º

#### æŠ€æœ¯å®ç°

- **è®¤è¯æ–¹å¼**: JWT (Access Token + Refresh Token)
- **å¯†ç åŠ å¯†**: bcrypt
- **ä»¤ç‰Œè¿‡æœŸæ—¶é—´**:
  - Access Token: 15åˆ†é’Ÿ
  - Refresh Token: 7å¤©

#### æµç¨‹å›¾

```
ç”¨æˆ·ç™»å½•
   â†“
éªŒè¯æ‰‹æœºå·å’Œå¯†ç 
   â†“
ç”Ÿæˆ JWT Access Token (15åˆ†é’Ÿ)
ç”Ÿæˆ JWT Refresh Token (7å¤©)
   â†“
è¿”å›åŒä»¤ç‰Œ
   â†“
åç»­è¯·æ±‚æºå¸¦ Access Token
   â†“
Access Token è¿‡æœŸ
   â†“
ä½¿ç”¨ Refresh Token åˆ·æ–°
   â†“
ç”Ÿæˆæ–°çš„åŒä»¤ç‰Œ
```

### 2. è®¢å•æ¨¡å— (OrderModule)

#### åŠŸèƒ½

- åˆ›å»ºå¯¹æ¥è®¢å•ï¼ˆå‘å¸ƒéœ€æ±‚ï¼‰
- è®¢å•çŠ¶æ€æµè½¬
- è®¢å•åˆ†é…ä¸æ´¾å•
- ä¸Šä¼ å®¢æˆ·éœ€æ±‚æŠ¥å‘Š
- è®¾ç½®è®¢å•ä»·æ ¼
- è®¢å•ä¸Šæ¶é“¶è¡Œç«¯
- åˆ›å»ºå§”æ‰˜è®¢å•

#### çŠ¶æ€æœºè®¾è®¡

**å¯¹æ¥è®¢å•çŠ¶æ€**:

```
PENDING_ASSIGN (å¾…åˆ†é…ç®¡æˆ·äºº)
    â†“
IN_REVIEW (éœ€æ±‚æ¢³ç†ä¸­)
    â†“
WAITING_PURCHASE (å¾…é“¶è¡Œè´­ä¹°)
    â†“
IN_OFFLINE (çº¿ä¸‹æ²Ÿé€šä¸­)
    â†“
CONFIRMED (å·²ç¡®è®¤åˆä½œ)
    â†“
    â””â”€â”€> CANCELLED (å·²å–æ¶ˆ)
    â””â”€â”€> FAILED (å·²å¤±è´¥)
```

**å§”æ‰˜è®¢å•çŠ¶æ€**:

```
PENDING_REVIEW (å·²å‘èµ·å§”æ‰˜)
    â”œâ”€â”€> APPROVED (å®¡æ ¸é€šè¿‡)
    â”‚       â†“
    â”‚   PROCESSING (å¤„ç†ä¸­)
    â”‚       â†“
    â”‚   COMPLETED (å·²å®Œæˆ)
    â”‚       â””â”€â”€> FAILED (å·²å¤±è´¥)
    â”‚
    â””â”€â”€> REJECTED (å®¡æ ¸æ‹’ç»)
```

#### çŠ¶æ€è½¬æ¢è§„åˆ™

| å½“å‰çŠ¶æ€         | ç›®æ ‡çŠ¶æ€         | è§¦å‘æ¡ä»¶       | æ“ä½œè§’è‰²   |
| ---------------- | ---------------- | -------------- | ---------- |
| PENDING_ASSIGN   | IN_REVIEW        | åˆ†é…ç®¡æˆ·äºº     | ADMIN      |
| IN_REVIEW        | WAITING_PURCHASE | ä¸Šä¼ æŠ¥å‘Šå¹¶å®šä»· | ADMIN      |
| WAITING_PURCHASE | IN_OFFLINE       | é“¶è¡Œè´­ä¹°è®¢å•   | BANK       |
| IN_OFFLINE       | CONFIRMED        | åŒæ–¹ç¡®è®¤       | USER, BANK |
| CONFIRMED        | -                | è®¢å•å®Œæˆ       | -          |

### 3. æ”¯ä»˜æ¨¡å— (PaymentModule)

#### åŠŸèƒ½

- åˆ›å»ºæ”¯ä»˜è®¢å•
- å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒ
- æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢
- ç”³è¯·é€€æ¬¾

#### æŠ€æœ¯å®ç°

- **æ”¯ä»˜æ–¹å¼**:
  - JSAPIæ”¯ä»˜ï¼ˆH5å†…åµŒï¼‰
  - Nativeæ”¯ä»˜ï¼ˆæ‰«ç ï¼‰
- **æ”¯ä»˜æµç¨‹**:

```
é“¶è¡Œå®¢æˆ·ç»ç†é€‰æ‹©è®¢å•
   â†“
åˆ›å»ºæ”¯ä»˜è®¢å•
   â†“
è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API
   â†“
è¿”å›æ”¯ä»˜å‚æ•°
   â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
   â†“
å¾®ä¿¡æ”¯ä»˜å›è°ƒ
   â†“
æ›´æ–°è®¢å•çŠ¶æ€
   â†“
ç”Ÿæˆåˆ†ä½£è®°å½•
```

#### å®‰å…¨è®¾è®¡

- ç­¾åéªŒè¯
- å›è°ƒIPç™½åå•
- é‡‘é¢äºŒæ¬¡æ ¡éªŒ
- é‡å¤æ”¯ä»˜æ£€æµ‹

### 4. åˆ†ä½£æ¨¡å— (CommissionModule)

#### åŠŸèƒ½

- é…ç½®åˆ†ä½£è§„åˆ™
- è®¡ç®—ä½£é‡‘
- ç”Ÿæˆåˆ†ä½£è®°å½•
- æŸ¥è¯¢åˆ†ä½£æ˜ç»†

#### åˆ†ä½£è§„åˆ™

é»˜è®¤åˆ†ä½£æ¯”ä¾‹ï¼ˆæŒ‰çœä»½å¯é…ç½®ï¼‰ï¼š

```
è®¢å•æ€»é¢ = 100%

å¹³å°æŠ½æˆ = 30%
ä»£ç†å•† = 10%
åŠ ç›Ÿå•† = 5%
æ¸ é“å•†+æœåŠ¡å•† = 15%
å¼€å‘äºº = 5%
ç®¡æˆ·äºº = 60% Ã· 3 = 20%
è®¿è°ˆäºº = 60% Ã· 3 = 20%
ä¸šåŠ¡å—ç†äºº = 60% Ã· 3 = 20%
```

**æ³¨æ„**: ä½œä¸šäººï¼ˆç®¡æˆ·äººã€è®¿è°ˆäººã€ä¸šåŠ¡å—ç†äººï¼‰çš„60%æ˜¯æŒ‰å®é™…å‚ä¸çš„ä½œä¸šäººåˆ†é…çš„ã€‚

#### åˆ†ä½£è®¡ç®—é€»è¾‘

```typescript
// ä¼ªä»£ç 
function calculateCommission(orderAmount: number, participants: string[]) {
  const platformShare = orderAmount * 0.3; // 30%
  const agentShare = orderAmount * 0.1; // 10%
  const franchiseShare = orderAmount * 0.05; // 5%
  const channelServiceShare = orderAmount * 0.15; // 15%
  const developerShare = orderAmount * 0.05; // 5%
  const workerShare = orderAmount * 0.6; // 60%

  const workerCount = participants.length;
  const perWorkerShare = workerShare / workerCount;

  return {
    platform: platformShare,
    agent: agentShare,
    franchise: franchiseShare,
    channel: channelServiceShare * 0.5,
    service: channelServiceShare * 0.5,
    developer: developerShare,
    workers: participants.map(() => perWorkerShare),
  };
}
```

### 5. æ–‡ä»¶æ¨¡å— (FileModule)

#### åŠŸèƒ½

- æ–‡ä»¶ä¸Šä¼ 
- æ–‡ä»¶ä¸‹è½½
- æ–‡ä»¶åˆ é™¤
- æ–‡ä»¶URLç”Ÿæˆ

#### æŠ€æœ¯å®ç°

- **å­˜å‚¨æ–¹æ¡ˆ**: é˜¿é‡Œäº‘OSS
- **æ–‡ä»¶é™åˆ¶**:
  - å•æ–‡ä»¶å¤§å°: 10MB
  - æ”¯æŒæ ¼å¼: jpg, jpeg, png, pdf
- **æ–‡ä»¶å‘½å**: UUID + æ—¶é—´æˆ³
- **è®¿é—®æ–¹å¼**:
  - å…¬å¼€æ–‡ä»¶: ç›´æ¥URLè®¿é—®
  - ç§æœ‰æ–‡ä»¶: ç­¾åURLï¼ˆä¸´æ—¶è®¿é—®æƒé™ï¼‰

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### å¯¹æ¥è®¢å•å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ 1. å‘å¸ƒéœ€æ±‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºå¯¹æ¥è®¢å•     â”‚
â”‚  çŠ¶æ€: PENDING_   â”‚
â”‚  ASSIGN          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 2. åˆ†é…ç®¡æˆ·äºº
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡æˆ·äººæ¥å•       â”‚
â”‚  çŠ¶æ€: IN_REVIEW  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 3. éœ€æ±‚æ¢³ç†
      â”‚    - ç®¡æˆ·äººè‡ªè¡Œæ‰¿æ¥
      â”‚    - æˆ–æ´¾å•è®¿è°ˆäºº
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸Šä¼ éœ€æ±‚æŠ¥å‘Š     â”‚
â”‚  (PDF/å›¾ç‰‡)       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 4. è®¾ç½®ä»·æ ¼
      â”‚    æ´¾å•é“¶è¡Œ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•ä¸Šæ¶         â”‚
â”‚  çŠ¶æ€: WAITING_  â”‚
â”‚  PURCHASE        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 5. é“¶è¡Œè´­ä¹°
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é“¶è¡Œç»ç† â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ 6. æ”¯ä»˜è´¹ç”¨
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·å–è”ç³»æ–¹å¼     â”‚
â”‚  çº¿ä¸‹æ²Ÿé€š         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 7. ç°åœºç¡®è®¤
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡æˆ·äººç¡®è®¤      â”‚
â”‚  é“¶è¡Œç»ç†ç¡®è®¤     â”‚
â”‚  è´¹ç”¨ä¸å¯é€€      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 8. é€‰æ‹©é“¶è¡Œ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·é€‰æ‹© â”‚
â”‚  åˆä½œé“¶è¡Œ â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ 9. (å¯é€‰)
      â”‚    å‘èµ·å§”æ‰˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºå§”æ‰˜è®¢å•     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å§”æ‰˜è®¢å•å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ 1. å‘èµ·å§”æ‰˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºå§”æ‰˜è®¢å•     â”‚
â”‚  çŠ¶æ€: PENDING_  â”‚
â”‚  REVIEW          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 2. ä¸Šä¼ åè®®
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡æˆ·äººä¸Šä¼        â”‚
â”‚  å§”æ‰˜åè®®         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 3. å¹³å°å®¡æ ¸
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†å‘˜å®¡æ ¸       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€> 4a. å®¡æ ¸é€šè¿‡
      â”‚        â–¼
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚  åˆ†é…ä¸šåŠ¡å—ç†äºº    â”‚
      â”‚   â”‚  çŠ¶æ€: PROCESSING  â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚         â”‚ 5. å¯¹æ¥é“¶è¡Œ
      â”‚         â–¼
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚  åŠç†æ‰‹ç»­        â”‚
      â”‚   â”‚  é“¶è¡Œåé¦ˆå®¡æ‰¹     â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚         â”‚ 6. è®¢å•å®Œæˆ
      â”‚         â–¼
      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚  çŠ¶æ€: COMPLETED  â”‚
      â”‚   â”‚  çŠ¶æ€: FAILED     â”‚
      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â””â”€â”€> 4b. å®¡æ ¸æ‹’ç»
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  çŠ¶æ€: REJECTED  â”‚
         â”‚  è®¢å•ç»“æŸ        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ”¯ä»˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é“¶è¡Œç»ç†  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ 1. é€‰æ‹©è®¢å•
      â”‚    ç‚¹å‡»è´­ä¹°
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºæ”¯ä»˜è®¢å•     â”‚
â”‚  çŠ¶æ€: PENDING    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 2. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾®ä¿¡æ”¯ä»˜API      â”‚
â”‚  - JSAPI         â”‚
â”‚  - Native        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 3. è¿”å›æ”¯ä»˜å‚æ•°
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ”¯ä»˜  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ 4. å®Œæˆæ”¯ä»˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾®ä¿¡å›è°ƒ         â”‚
â”‚  éªŒè¯ç­¾å        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 5. æ›´æ–°è®¢å•çŠ¶æ€
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¯ä»˜è®¢å•: PAID  â”‚
â”‚  è®¢å•çŠ¶æ€æ›´æ–°     â”‚
â”‚  ç”Ÿæˆåˆ†ä½£è®°å½•     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†ä½£è®¡ç®—æµç¨‹

```
è®¢å•æ”¯ä»˜æˆåŠŸ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·å–åˆ†ä½£è§„åˆ™     â”‚
â”‚  (æŒ‰çœä»½)        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¡ç®—å„è§’è‰²ä½£é‡‘   â”‚
â”‚  - å¹³å°æŠ½æˆ      â”‚
â”‚  - ä»£ç†å•†        â”‚
â”‚  - åŠ ç›Ÿå•†        â”‚
â”‚  - æ¸ é“å•†+æœåŠ¡å•†  â”‚
â”‚  - å¼€å‘äºº        â”‚
â”‚  - ä½œä¸šäºº        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿæˆåˆ†ä½£è®°å½•     â”‚
â”‚  çŠ¶æ€: PENDING    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®šæœŸç»“ç®—        â”‚
â”‚  çŠ¶æ€: PAID      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. è®¤è¯å®‰å…¨

#### JWTåŒä»¤ç‰Œæœºåˆ¶

**Access Token**:

- ç”¨é€”: APIè¯·æ±‚è®¤è¯
- æœ‰æ•ˆæœŸ: 15åˆ†é’Ÿ
- å­˜å‚¨ä½ç½®: å†…å­˜ï¼ˆå‰ç«¯ï¼‰
- åŒ…å«ä¿¡æ¯: userId, role, permissions

**Refresh Token**:

- ç”¨é€”: åˆ·æ–°Access Token
- æœ‰æ•ˆæœŸ: 7å¤©
- å­˜å‚¨ä½ç½®: HttpOnly Cookieï¼ˆé˜²XSSï¼‰
- å¯æ’¤é”€: æ”¯æŒé»‘åå•æœºåˆ¶

#### å¯†ç å®‰å…¨

- **åŠ å¯†ç®—æ³•**: bcrypt
- **å·¥ä½œå› å­**: 10
- **å­˜å‚¨æ–¹å¼**: ä»…å­˜å‚¨å“ˆå¸Œå€¼

### 2. æˆæƒå®‰å…¨

#### è§’è‰²æƒé™æ§åˆ¶ (RBAC)

```typescript
// å››ç§è§’è‰²
enum UserRole {
  USER, // æ™®é€šç”¨æˆ·
  PROVIDER, // æœåŠ¡å•†
  BANK, // é“¶è¡Œå®¢æˆ·ç»ç†
  ADMIN, // è¿è¥ç®¡ç†å‘˜
}

// æœåŠ¡å•†å­æƒé™
enum ProviderPermission {
  ACCOUNT_MANAGER, // ç®¡æˆ·äºº
  INTERVIEWER, // è®¿è°ˆäºº
  HANDLER, // ä¸šåŠ¡å—ç†äºº
}
```

#### æ¥å£æƒé™ä¿æŠ¤

```typescript
// ä½¿ç”¨è£…é¥°å™¨ä¿æŠ¤è·¯ç”±
@Controller('order')
export class OrderController {
  @Post()
  @UseGuards(JwtAuthGuard)
  @Roles(UserRole.USER)
  createOrder() {
    // ä»…ç”¨æˆ·å¯è®¿é—®
  }

  @Put(':id/set-price')
  @UseGuards(JwtAuthGuard)
  @Roles(UserRole.ADMIN)
  setPrice() {
    // ä»…ç®¡ç†å‘˜å¯è®¿é—®
  }
}
```

### 3. æ•°æ®å®‰å…¨

#### æ•æ„Ÿæ•°æ®åŠ å¯†

- **å¯†ç **: bcryptå“ˆå¸Œ
- **æ‰‹æœºå·**: æ•°æ®è„±æ•ï¼ˆ138\*\*\*\*1234ï¼‰
- **èº«ä»½è¯**: æ•°æ®è„±æ•ï¼ˆ110****\*\*\*****1234ï¼‰
- **åœ°å€**: æ•°æ®è„±æ•ï¼ˆéšè—è¯¦ç»†é—¨ç‰Œå·ï¼‰

#### æ•°æ®è„±æ•ç­–ç•¥

```typescript
// é“¶è¡Œç«¯æŸ¥çœ‹è®¢å•æ—¶è‡ªåŠ¨è„±æ•
function sanitizeForBank(order: ConnectionOrder) {
  return {
    ...order,
    user: {
      ...order.user,
      phone: maskPhone(order.user.phone),
      idCard: maskIdCard(order.user.idCard),
    },
    location: maskAddress(order.location),
  };
}
```

### 4. APIå®‰å…¨

#### è¯·æ±‚é™æµ

- ä½¿ç”¨NestJS Throttler
- é»˜è®¤: æ¯åˆ†é’Ÿ100æ¬¡è¯·æ±‚
- ç™»å½•æ¥å£: æ¯åˆ†é’Ÿ5æ¬¡è¯·æ±‚
- æ”¯ä»˜æ¥å£: æ¯åˆ†é’Ÿ10æ¬¡è¯·æ±‚

#### XSSé˜²æŠ¤

- ä½¿ç”¨Helmetä¸­é—´ä»¶
- Content Security Policy (CSP)
- XSSè¿‡æ»¤å™¨

#### CSRFé˜²æŠ¤

- SameSite Cookieå±æ€§
- CSRF TokenéªŒè¯

### 5. æ”¯ä»˜å®‰å…¨

#### å¾®ä¿¡æ”¯ä»˜å®‰å…¨

- ç­¾åéªŒè¯
- å›è°ƒIPç™½åå•
- é‡‘é¢äºŒæ¬¡æ ¡éªŒ
- é‡å¤æ”¯ä»˜æ£€æµ‹
- è®¢å•çŠ¶æ€æ ¡éªŒ

```typescript
// æ”¯ä»˜å›è°ƒéªŒè¯
async verifyCallback(signature, body) {
  // 1. éªŒè¯ç­¾å
  if (!this.verifySignature(signature, body)) {
    throw new UnauthorizedException('Invalid signature');
  }

  // 2. éªŒè¯IP
  if (!this.isWhitelistedIP(ip)) {
    throw new UnauthorizedException('IP not whitelisted');
  }

  // 3. éªŒè¯è®¢å•
  const order = await this.findOrder(body.order_id);
  if (order.status === PaymentStatus.PAID) {
    throw new BadRequestException('Order already paid');
  }

  // 4. é‡‘é¢æ ¡éªŒ
  if (order.amount !== body.amount) {
    throw new BadRequestException('Amount mismatch');
  }
}
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–

```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_role ON users(role);

-- è®¢å•è¡¨ç´¢å¼•
CREATE INDEX idx_orders_user_id ON connection_orders(user_id);
CREATE INDEX idx_orders_status ON connection_orders(status);
CREATE INDEX idx_orders_created_at ON connection_orders(created_at);
CREATE INDEX idx_orders_order_no ON connection_orders(order_no);

-- æ”¯ä»˜è¡¨ç´¢å¼•
CREATE INDEX idx_payments_order_id ON payments(order_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_transaction_id ON payments(transaction_id);
```

#### æŸ¥è¯¢ä¼˜åŒ–

- ä½¿ç”¨SELECTæŒ‡å®šå­—æ®µï¼Œé¿å…SELECT \*
- åˆç†ä½¿ç”¨JOINï¼Œé¿å…N+1æŸ¥è¯¢
- ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ï¼Œé¿å…å…¨è¡¨æ‰«æ
- ä½¿ç”¨ç¼“å­˜çƒ­ç‚¹æ•°æ®

### 2. ç¼“å­˜ç­–ç•¥

#### Redisç¼“å­˜ï¼ˆå¯é€‰ï¼‰

```typescript
// ç¼“å­˜çƒ­ç‚¹æ•°æ®
@Cacheable('user', 3600)  // ç¼“å­˜1å°æ—¶
async getUserProfile(userId: number) {
  return this.userRepository.findOne(userId);
}

// ç¼“å­˜åˆ†ä½£è§„åˆ™
@Cacheable('commission_rules', 7200)  // ç¼“å­˜2å°æ—¶
async getCommissionRules(province: string) {
  return this.commissionRuleRepository.findOne({ where: { province } });
}
```

### 3. æ¥å£ä¼˜åŒ–

#### å“åº”ä¼˜åŒ–

- ä½¿ç”¨DTOå­—æ®µé€‰æ‹©
- å‹ç¼©å“åº”æ•°æ®ï¼ˆGzipï¼‰
- åˆ†é¡µè¿”å›å¤§æ•°æ®é‡

#### å¹¶å‘ä¼˜åŒ–

- ä½¿ç”¨Promise.allå¹¶è¡Œè¯·æ±‚
- ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—å¤„ç†è€—æ—¶ä»»åŠ¡

### 4. è¿æ¥æ± ä¼˜åŒ–

```typescript
// TypeORMè¿æ¥æ± é…ç½®
{
  type: 'mysql',
  host: 'localhost',
  port: 3306,
  username: 'root',
  password: 'password',
  database: 'yinhang_platform',
  entities: ['dist/**/*.entity.js'],
  synchronize: false,
  logging: false,
  // è¿æ¥æ± é…ç½®
  poolSize: 20,              // æœ€å¤§è¿æ¥æ•°
  extra: {
    connectionLimit: 20,
    acquireTimeout: 60000,  // è·å–è¿æ¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  }
}
```

## ğŸš€ æ‰©å±•æ€§è®¾è®¡

### 1. æ°´å¹³æ‰©å±•

#### æ— çŠ¶æ€è®¾è®¡

- JWTè®¤è¯ï¼Œæ— Sessionä¾èµ–
- æ–‡ä»¶å­˜å‚¨OSSï¼Œä¸å ç”¨æœ¬åœ°å­˜å‚¨
- æ•°æ®åº“æ”¯æŒä¸»ä»å¤åˆ¶

#### è´Ÿè½½å‡è¡¡

ä½¿ç”¨Nginxè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼š

```nginx
upstream backend {
    server 192.168.1.1:3000;
    server 192.168.1.2:3000;
    server 192.168.1.3:3000;
}
```

### 2. å‚ç›´æ‰©å±•

#### å¾®æœåŠ¡æ‹†åˆ†ï¼ˆæœªæ¥è§„åˆ’ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       API Gateway               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
    â–¼     â–¼     â–¼     â–¼     â–¼
â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”
â”‚ç”¨æˆ·â”‚ â”‚è®¢å•â”‚ â”‚æ”¯ä»˜â”‚ â”‚åˆ†ä½£â”‚ â”‚æ–‡ä»¶â”‚
â”‚æœåŠ¡â”‚ â”‚æœåŠ¡â”‚ â”‚æœåŠ¡â”‚ â”‚æœåŠ¡â”‚ â”‚æœåŠ¡â”‚
â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜
```

### 3. æ•°æ®åº“æ‰©å±•

#### è¯»å†™åˆ†ç¦»

```typescript
// ä¸»åº“é…ç½®ï¼ˆå†™ï¼‰
const masterConfig = {
  type: 'mysql',
  host: 'mysql-master',
  // ...
};

// ä»åº“é…ç½®ï¼ˆè¯»ï¼‰
const slaveConfig = {
  type: 'mysql',
  host: 'mysql-slave',
  // ...
};
```

#### åˆ†åº“åˆ†è¡¨ï¼ˆæœªæ¥è§„åˆ’ï¼‰

- æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†åº“
- è®¢å•è¡¨æŒ‰æ—¶é—´åˆ†è¡¨
- ç”¨æˆ·è¡¨æŒ‰IDåˆ†è¡¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-03
**æœ€åæ›´æ–°**: 2026-02-03
